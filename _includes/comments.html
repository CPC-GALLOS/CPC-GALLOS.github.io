<!-- The comments switcher -->
{% if page.comments and site.comments.provider %}
  {% capture path %}comments/{{ site.comments.provider }}.html{% endcapture %}
  {% include {{ path }} %}
  <script src="https://giscus.app/client.js"
    data-repo="CPC-GALLOS/CPC-GALLOS.github.io"
    data-repo-id="R_kgDOMP4eWg"
    data-category="Blog"
    data-category-id="DIC_kwDOMP4eWs4ChCzC"
    data-mapping="title"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="bottom"
    data-theme="preferred_color_scheme"
    data-lang="es"
    crossorigin="anonymous"
    async>
  </script>
  <div class="giscus-frame" style="margin-top: 24px">
    <div class="giscus"></div>
  </div>
  <script>
    function updateGiscusTheme() {
      console.log("updateGiscusTheme called");
      const dataMode = document.documentElement.getAttribute("data-mode");
      const theme = dataMode
        ? (dataMode === "dark" ? "dark_dimmed" : "light")
        : (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark_dimmed" : "light");
      console.log("Theme set to:", theme);

      // Update Giscus script theme
      const giscusScript = document.querySelector('script[src="https://giscus.app/client.js"]');
      if (giscusScript) {
        giscusScript.setAttribute("data-theme", theme);
      }

      // Update Giscus iframe theme
      const giscusIframe = document.querySelector("iframe.giscus-frame");
      if (giscusIframe) {
        try {
          giscusIframe.contentWindow.postMessage(
            { giscus: { setConfig: { theme: theme } } },
            "https://giscus.app"
          );
          console.log("Message posted to Giscus iframe");
        } catch (error) {
          console.error("Error posting message to Giscus iframe:", error);
        }
      }
    }

    function waitForGiscus() {
      const interval = setInterval(() => {
        console.log("Waiting for Giscus to load...");
        const giscusIframe = document.querySelector("iframe.giscus-frame");

        if (giscusIframe) {
          clearInterval(interval);
          console.log("Giscus loaded, updating theme...");
          updateGiscusTheme();
        }
      }, 100);

      // Avoid infinite loop
      setTimeout(() => clearInterval(interval), 10000);
    }

    // Ensure the theme is set after the page has fully loaded
    document.addEventListener("DOMContentLoaded", function() {
      console.log("DOM fully loaded and parsed");
      waitForGiscus();

      // Observe changes in the data-mode attribute
      const modeObserver = new MutationObserver(mutations => {
        mutations.forEach(mutation => {
          if (mutation.attributeName === "data-mode") {
            console.log("data-mode attribute changed");
            updateGiscusTheme();
          }
        });
      });
      modeObserver.observe(document.documentElement, { attributes: true });
    });

    // Ensure the theme is set on page load
    window.onload = function() {
      waitForGiscus();
    };
  </script>
{% endif %}
